/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/odata/ODataUtils","sap/ui/core/library","sap/ui/thirdparty/URI","sap/ui/core/message/MessageParser","sap/ui/core/message/Message","sap/base/Log"],function(e,r,t,s,a,i){"use strict";var o="simplot.portalsprd.utils.MessageParser",n=/^\/+|\/$/g,d=r.MessageType,u={error:d.Error,info:d.Information,success:d.Success,warning:d.Warning};var p=s.extend("simplot.portalsprd.utils.MessageParser",{metadata:{publicMethods:["parse","setProcessor","getHeaderField","setHeaderField"]},constructor:function(){s.apply(this);this._headerField="sap-message";this._lastMessages=[]}});p.prototype.getHeaderField=function(){return this._headerField};p.prototype.setHeaderField=function(e){this._headerField=e;return this};p.prototype.parse=function(e,r,t,s,a){var o,n,d=String(e.statusCode);n={response:e};if(e.statusCode>=200&&e.statusCode<300){o=this._parseHeader(e,n)}else if(e.statusCode>=400&&e.statusCode<600){try{o=this._parseBody(e,n);this._logErrorMessages(o,r,d)}catch(e){o=this._createGenericError(n);i.error("Request failed with status code "+d)}}else{o=this._createGenericError(n);i.error("Request failed with unsupported status code "+d)}return o};p.prototype._createMessage=function(e,r,t){var s=e.target&&e.target.indexOf("/#TRANSIENT#")===0||e.transient||e.transition||t&&this._bPersistTechnicalMessages,i=typeof e.message==="object"?e.message.value:e.message,o=e["@sap.severity"]||e.severity;e.transition=!!s;return new a({code:e.code||"",description:e.description,descriptionUrl:e.longtext_url||"",message:i,persistent:!!s,processor:this._processor,technical:t,technicalDetails:{headers:r.response.headers,statusCode:r.response.statusCode},type:u[o]||o})};p.prototype._parseHeader=function(e,r){var t,s,a,o,n=this.getHeaderField(),d=[];if(!e.headers){return d}for(s in e.headers){if(s.toLowerCase()===n.toLowerCase()){n=s}}if(!e.headers[n]){return d}a=e.headers[n];try{o=JSON.parse(a);d.push(this._createMessage(o,r));if(Array.isArray(o.details)){for(t=0;t<o.details.length;t+=1){d.push(this._createMessage(o.details[t],r))}}}catch(e){i.error("The message string returned by the back-end could not be parsed: '"+e.message+"'");return d}return d};p.prototype._parseBody=function(e,r){var t=c(e);return t&&t.indexOf("xml")>-1?this._parseBodyXML(e,r,t):this._parseBodyJSON(e,r)};p.prototype._createGenericError=function(e){return[this._createMessage({description:e.response.body,message:sap.ui.getCore().getLibraryResourceBundle().getText("CommunicationError"),severity:d.Error,transition:true},e,true)]};p.prototype._getBodyMessages=function(e,r,t){var s=[],a=this._createMessage(e,t,true),i=this;r.forEach(function(e){var r=i._createMessage(e,t,true);if(a&&a.getCode()===r.getCode()&&a.getMessage()===r.getMessage()){a=undefined}if(!e.ContentID){s.push(r)}});if(a){s.unshift(a)}return s};p.prototype._logErrorMessages=function(e,r,t){var s=e.length?JSON.stringify(e.map(function(e){return{code:e.getCode(),message:e.getMessage(),persistent:e.getPersistent(),targets:e.getTargets(),type:e.getType()}})):"Another request in the same change set failed";i.error("Request failed with status code "+t,s,o)};p.prototype._parseBodyXML=function(e,r,t){var s,a,i,o,n,u,p,c=(new DOMParser).parseFromString(e.body,t),l=g(c,["error","errordetail"]),h=[];if(!l.length){return this._createGenericError(r)}for(o=0;o<l.length;o+=1){p=l[o];i={};i.severity=d.Error;for(u=0;u<p.childNodes.length;u+=1){s=p.childNodes[u];a=s.nodeName;if(a==="errordetails"||a==="details"||a==="innererror"||a==="#text"){continue}if(a==="message"&&s.hasChildNodes()&&s.firstChild.nodeType!==window.Node.TEXT_NODE){for(n=0;n<s.childNodes.length;n+=1){if(s.childNodes[n].nodeName==="value"){i.message=s.childNodes[n].text||s.childNodes[n].textContent}}}else{i[s.nodeName]=s.text||s.textContent}}h.push(i)}return this._getBodyMessages(h[0],h.slice(1),r)};p.prototype._parseBodyJSON=function(e,r){var t,s,a=JSON.parse(e.body);if(a.error){s=a.error}else{s=a["odata.error"]}if(!s){i.error("Error message returned by server did not contain error-field");return this._createGenericError(r)}s.severity=d.Error;if(Array.isArray(s.details)){t=s.details}else if(s.innererror&&Array.isArray(s.innererror.errordetails)){t=s.innererror.errordetails}else{t=[]}return this._getBodyMessages(s,t,r)};p.prototype._parseUrl=function(e){var r={url:e,parameters:{},hash:""};var s=-1;s=e.indexOf("#");if(s>-1){r.hash=r.url.substr(s+1);r.url=r.url.substr(0,s)}s=e.indexOf("?");if(s>-1){var a=r.url.substr(s+1);r.parameters=t.parseQuery(a);r.url=r.url.substr(0,s)}return r};p.prototype._setPersistTechnicalMessages=function(e){this._bPersistTechnicalMessages=e};function c(e){if(e&&e.headers){for(var r in e.headers){if(r.toLowerCase()==="content-type"){return e.headers[r].replace(/([^;]*);.*/,"$1")}}}return false}var l=document.createElement("a");function h(e){l.href=e;return t.parse(l.href).path}function g(e,r){var t=[];var s={};for(var a=0;a<r.length;a+=1){s[r[a]]=true}var i=e;while(i){if(s[i.tagName]){t.push(i)}if(i.hasChildNodes()){i=i.firstChild}else{while(!i.nextSibling){i=i.parentNode;if(!i||i===e){i=null;break}}if(i){i=i.nextSibling}}}return t}return p});