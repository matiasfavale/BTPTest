sap.ui.define(["simplot/portalsqas/utils/models","simplot/portalsqas/utils/gateway","simplot/portalsqas/utils/modelHelper","simplot/portalsqas/utils/FileDownHelp","simplot/portalsqas/utils/Common","sap/m/Button","sap/m/Dialog","sap/m/Text"],function(e,t,o,a,r,n,s,i){"use strict";var l="Model_CtaCte";var u="CUENTACTE";var C="CUENTACTE_ES";var c="AUTOGESTION";var g="Model_ControllerMain";return{getCommon:function(){var e=sap.ui.require("simplot/portalsqas/utils/Common");return e},getI18nText:function(t){return e.get("i18n").getProperty(t)},navToCtaCte:function(e){this.onLoadModelCtaCte();e.display("cuentacorriente")},onLoadModelCtaCte:function(){var t=this.getCommon();var o=[{Id:"0",Name:t.getI18nText("Preliminar")},{Id:"1",Name:t.getI18nText("Abierto")},{Id:"2",Name:t.getI18nText("Compensada")}];var a=[{Id:"FC",Name:t.getI18nText("Factura")},{Id:"NC",Name:t.getI18nText("NotaCredito")},{Id:"ND",Name:t.getI18nText("NotaDebito")}];if(e.exists(l)){}else{e.load(l,{rowsCtaCte:[],rowsCtaCteBack:[],rowsCtaCteCount:0,rowsCtaCteRealCount:0,rowsCtaCteRel:[],rowsCtaCteRelBack:[],rowsCtaCteRelCount:0,valueSearch:"",HeaderCtaCte:{},Filtros:{rowsEstado:o,selectEstado:[],rowsComprobante:a,selectComprobante:[],dateValueOne:undefined,dateValueTwo:undefined}})}e.get(l).refresh();this.onCtasCtes()},onCtasCtes:function(o){var a=this.getCommon();var r={Texo:a.getI18nText("Preliminar"),Icon:"sap-icon://status-critical",Color:"#ff5e00"};var n={Texo:a.getI18nText("Abierto"),Icon:"status-negative",Color:"red"};var s={Texo:a.getI18nText("Compensada"),Icon:"status-completed",Color:"green"};var i=this;debugger;var C=e.get("Model_User").getProperty("/DataUser");var g="/ObtenerBasicoSet(IvBpPortal='"+C.BpPortal+"',IvTipoBp='P')";t.read(c,g,{}).then(function(o){var i=o;i.tileFecha=(new Date).toLocaleDateString();var c="/PartidasSet";var g=new sap.ui.model.Filter("IvLifnr","EQ",C.NrSap);t.read(u,c,{filters:[g]}).then(function(t){var o=8;var u=t.results;for(var C in u){u[C].FechaCont=a.formatDate(u[C].FechaCont,"Main");u[C].FechaVenc=a.formatDate(u[C].FechaVenc,"Main");u[C].FechaEmi=a.formatDate(u[C].FechaEmi,"Main");u[C].Importe=Number(u[C].Importe).toFixed(2);if(u[C].Estado.toString()==="0"){u[C].StatusIcon=r.Icon;u[C].StatusColor=r.Color;u[C].StatusText=r.Texto;u[C].StatusVisible=true}else if(u[C].Estado.toString()==="1"){u[C].StatusIcon=n.Icon;u[C].StatusColor=n.Color;u[C].StatusText=n.Texto;u[C].StatusVisible=true}else if(u[C].Estado.toString()==="2"){u[C].StatusIcon=s.Icon;u[C].StatusColor=s.Color;u[C].StatusText=s.Texto;u[C].StatusVisible=true}else{u[C].StatusIcon="sap-icon://status-completed";u[C].StatusColor="#3bc13b";u[C].StatusText="";u[C].StatusVisible=false}}e.get(l).setProperty("/HeaderCtaCte",i);e.get(l).setProperty("/rowsCtaCte",u);e.get(l).setProperty("/rowsCtaCteBack",u);if(o>u.length){o=u.length}e.get(l).setProperty("/rowsCtaCteRealCount",u.length);e.get(l).setProperty("/rowsCtaCteCount",o)}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})},sortGlobal:function(e,t){if(e["FechaHora"]>t["FechaHora"]){return-1}if(e["FechaHora"]<t["FechaHora"]){return 1}return 0},onViewCtaCte:function(o){var a=this;var r=this.getCommon();var n={Texo:r.getI18nText("Preliminar"),Icon:"sap-icon://status-critical",Color:"#ff5e00"};var s={Texo:r.getI18nText("Abierto"),Icon:"status-negative",Color:"red"};var i={Texo:r.getI18nText("Compensada"),Icon:"status-completed",Color:"green"};var C=new sap.ui.model.Filter("IvBelnr","EQ",o.Belnr);var c=new sap.ui.model.Filter("IvBukrs","EQ",o.Bukrs);var g=new sap.ui.model.Filter("IvBuzei","EQ",o.Buzei);var d=new sap.ui.model.Filter("IvGjahr","EQ",o.Gjahr);var m="/PartidasRelSet";t.read(u,m,{filters:[C,c,g,d]}).then(function(t){var o=8;var u=t.results;for(var C in u){u[C].FechaCont=r.formatDate(u[C].FechaCont,"Main");u[C].FechaEmi=r.formatDate(u[C].FechaEmi,"Main");if(u[C].CodDoc.toUpperCase()==="OP"){u[C].visBtnPDF=true}else{u[C].visBtnPDF=false}if(Number(u[C].Importe)===0){u[C].Importe=""}else{u[C].Importe=Number(u[C].Importe).toFixed(2)}if(u[C].Estado.toString()==="0"){u[C].StatusIcon=n.Icon;u[C].StatusColor=n.Color;u[C].StatusText=n.Texto;u[C].StatusVisible=true}else if(u[C].Estado.toString()==="1"){u[C].StatusIcon=s.Icon;u[C].StatusColor=s.Color;u[C].StatusText=s.Texto;u[C].StatusVisible=true}else if(u[C].Estado.toString()==="2"){u[C].StatusIcon=i.Icon;u[C].StatusColor=i.Color;u[C].StatusText=i.Texto;u[C].StatusVisible=true}else{u[C].StatusIcon="sap-icon://status-completed";u[C].StatusColor="#3bc13b";u[C].StatusText="";u[C].StatusVisible=false}}e.get(l).setProperty("/rowsCtaCteRel",u);e.get(l).setProperty("/rowsCtaCteRelBack",u);if(o>u.length){o=u.length}e.get(l).setProperty("/rowsCtaCteRelCount",o);e.get(l).refresh();a.onOpenCtaCtaRel()}).catch(function(e){console.log(e)})},onOpenCtaCtaRel:function(){var o=this.getCommon();var a,r=new jQuery.Deferred;var n=e.get(g).getProperty("/ControllerMain");if(!n._ControllerViewCtaCte){n._ControllerViewCtaCte={deferred:null,onPressConfirm:function(e){a.close()},onPressPDF:function(e){debugger;o.onShowBusy();o.onChangeTextBusy(o.getI18nText("MsgFileDownload"));var a=e.getSource().getBindingContext().getObject();var r=a.Bukrs;var n=a.Belnr;var s=a.Gjahr;var i="OP_"+r+"_"+n+"_"+s+".pdf";var l="/OrdenPagoPdfSet(IvBukrs='"+r+"',IvBelnr='"+n+"',IvGjahr='"+s+"')";t.read(u,l,{}).then(function(e){var t=e.Contenido;if(t===""){sap.m.MessageBox.error(o.getI18nText("MsgNotFile"))}else{o.onDownloadFile(t,"",i)}o.onCloseBusy()}).catch(function(e){o.onCloseBusy();sap.m.MessageBox.error(o.getI18nText("MsgErrorFile"));console.log("error")})},onPressRetencionesPDF:function(a){o.onShowBusy();o.onChangeTextBusy(o.getI18nText("MsgFileDownload"));var r=a.getSource().getBindingContext().getObject();var n=r.Bukrs;var s=r.Belnr;var i=r.Gjahr;var l="Retencion_"+n+"_"+s+"_"+i+".pdf";var u=new sap.ui.model.Filter("IvBelnr","EQ",s);var c=new sap.ui.model.Filter("IvBukrs","EQ",n);var g=new sap.ui.model.Filter("IvGjahr","EQ",i);var d="/CertRetenPdfSet";e.get(C).aUrlParams[1]="sap-language=es";e.get(C).mMetadataUrlParams["sap-language"]="es";t.read(C,d,{filters:[u,c,g]}).then(function(e){var t=e.results;if(t.length>0){for(var a in t){if(t[a].Contenido===""){}else{o.onDownloadFile(t[a].Contenido,"",t[a].Archivo)}}}else{sap.m.MessageBox.error(o.getI18nText("MsgNotFile"))}o.onCloseBusy()}).catch(function(e){o.onCloseBusy();sap.m.MessageBox.error(o.getI18nText("MsgErrorFile"));console.log("error")})}}}n._ControllerViewCtaCte.deferred=r;if(!n._dialogViewCtaCte){n._dialogViewCtaCte=sap.ui.xmlfragment("simplot.portalsqas.view.fragment.ViewCtaCte",n._ControllerViewCtaCte)}a=n._dialogViewCtaCte;a.setModel(e.get(l));n.getView().addDependent(a);a.open()}}});