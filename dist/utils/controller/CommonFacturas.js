sap.ui.define(["simplot/portalsqas/utils/models","simplot/portalsqas/utils/gateway","simplot/portalsqas/utils/FileDownHelp","simplot/portalsqas/utils/Common","sap/m/Button","sap/m/Dialog","sap/m/Text"],function(e,o,t,a,r,n,s){"use strict";var i="FACTURA";var l="AFIP";var c="AUTOGESTION";var m="GENERAL";var d="ORDEN_COMPRA";var p="Model_Facturas";var u="Model_ControllerMain";var f="/comsapappsdocumentinformationextraction.businessservice/api";var g="/document-information-extraction/v1";var v;var b="Model_OC";return{onGetEnvironment:function(){v=f},getCommon:function(){var e=sap.ui.require("simplot/portalsqas/utils/Common");return e},getI18nText:function(o){return e.get("i18n").getProperty(o)},onLoadListOC:function(){var t=this.getCommon();var a=this;var r="/OCListadoSet";var n=e.get("Model_User").getProperty("/DataUser/NrSap");var s=new sap.ui.model.Filter("IvLifnr","EQ",n);var i=new sap.ui.model.Filter("IvSaldos","EQ",true);o.read(d,r,{filters:[s,i]}).then(function(o){var a=o.results;for(var r in a){a[r].Fecha=t.formatDate(a[r].Aedat,"Main");if(a[r].IdEstado==="1"){a[r].InfoStatus="Success"}else if(a[r].IdEstado==="2"){a[r].InfoStatus="Information"}else if(a[r].IdEstado==="3"){a[r].InfoStatus="Warning"}else if(a[r].IdEstado==="4"){a[r].InfoStatus="Error"}a[r].SaldoFact=t.onReturnFormatNumber(Number(a[r].SaldoFact),2)}a=a.filter(e=>e.IdEstado!=="1");e.get(p).setProperty("/comboOrdenCompra/rowTemplate",a);e.get(p).refresh();console.log(o)}).catch(function(e){console.log(e)})},onLoadExenciones:function(){var t="/ExencionesSet";o.read(i,t,{}).then(function(o){console.log("/ExencionesSet");console.log(o);var t=o.results;e.get(p).setProperty("/ListaExenciones",t)}).catch(function(e){console.log(e)})},onLoadModelFacturas:function(){this.onGetEnvironment();var o=[{name:"Limpiolux*",template:"aa962fe5-cb10-4068-ad14-204a3c4f7282"},{name:"Cartocor*",template:"42fce946-344f-4c5d-be7e-559de33117c4"},{name:"Bunge",template:"71b54fdc-9b71-4d99-8c45-1bf26ee02c89"},{name:"Plastiandino",template:"3c50d687-1c90-41a2-a3f5-ba90d20cd986"},{name:"AB_Logistica",template:"da98fd82-58bc-4dd2-87ba-8afde3701917"},{name:"LR_Ambiental",template:"dd0fb27b-0e4d-45cc-a216-935028e27fe1"},{name:"Mediterranea*",template:"eca5225c-9036-45f3-8321-1f825df36bef"},{name:"Verdenelli",template:"ff96d6ef-be59-4724-8803-1b4baf5c9e0f"},{name:"Petropack*",template:"f3fc7bf9-cc39-4322-9e55-c1a8a76d39ea"},{name:"Astie",template:"7ec90d83-44d7-4ed6-8fa5-6799bb24a5ca"},{name:"Cordenonsi",template:"af93f566-4109-4a96-821e-45bf4f38ab49"},{name:"Terminal_Zarate",template:"7ca7ce13-7ff8-40dd-a054-0047de058dab"},{name:"Mecatronica_Montajes*",template:"962fc824-805d-4fbe-beb7-7d74d84ef4e5"},{name:"Pooling",template:"772c38e1-9068-4dd9-ab82-5e2ac63debae"},{name:"ExpoVerde*",template:"2538576f-21c8-454d-b9eb-e5952ff82c8d"},{name:"Smurfit_Kappa*",template:"db532eb1-16e7-43fb-9c98-4c6a2630e7dd"}];var t=this.getCommon();var a=t.getCombosFacturas();if(e.exists(p)){this.onCleanModelFacturas(null)}else{e.load(p,{PDFViewer:a.ObjectoSourcePDF,Combos:a.AllCombos,ComboTemplate:{rowTemplate:o,selectKey:""},comboOrdenCompra:{rowTemplate:[],selectKey:"",required:false,habilitado:true},Expanded:false,File:"",headerFields:a.Header,lineItems:[],lineItemsMax:0,iibbItems:[],iibbItemsMax:0,ivaItems:[],ivaItemsMax:0,ListaExenciones:[],TemplatesOCR:[],DataUsuarioFCs:""})}e.get(p).refresh();this.onLoadListOC();this.onLoadExenciones();this.onGetSchemas();this.onGetSociedades();this.onGetTiposDoc()},onGetObtenerBasico:function(t){debugger;var a=e.get("Model_User").getProperty("/DataUser");var r="/ObtenerBasicoSet(IvBpPortal='"+a.BpPortal+"',IvTipoBp='P')";o.read(c,r,{}).then(function(o){var a=o;var r="123456";if(a.Nif!==""){r=a.Nif}const n="_"+r;var s=t.results.filter(e=>e.name.match(n));e.get(p).setProperty("/TemplatesOCR",s);e.get(p).setProperty("/DataUsuarioFCs",o);e.get(p).refresh()}).catch(function(e){console.log(e)})},onCleanModelFacturas:function(o){if(o===undefined||o===null){}else{o.getView().byId("myFileUploadFact").clear()}var t=this.getCommon();var a=t.getCombosFacturas();e.get(p).setProperty("/PDFViewer",a.ObjectoSourcePDF);e.get(p).setProperty("/Combos",a.AllCombos);e.get(p).setProperty("/Expanded",false);e.get(p).setProperty("/ComboTemplate/selectKey","");e.get(p).setProperty("/comboOrdenCompra/selectKey","");e.get(p).setProperty("/comboOrdenCompra/required",false);e.get(p).setProperty("/comboOrdenCompra/habilitado",true);e.get(p).setProperty("/File","");e.get(p).setProperty("/headerFields",a.Header);e.get(p).setProperty("/lineItems",[]);e.get(p).setProperty("/lineItemsMax",0);e.get(p).setProperty("/iibbItems",[]);e.get(p).setProperty("/iibbItemsMax",0);e.get(p).setProperty("/ivaItems",[]);e.get(p).setProperty("/ivaItemsMax",0);debugger;e.get(p).refresh()},onGetTiposDoc:function(){debugger;var t="/TiposDocSet";o.read(i,t,{}).then(function(o){e.get(p).setProperty("/Combos/comboSubtipoFactura/rowTemplateBack",o.results);e.get(p).refresh();console.log(o)}).catch(function(e){console.log(e)})},onGetSociedades:function(){var t=e.get("Model_User").getProperty("/DataUser");var a=new sap.ui.model.Filter("IvNrSap","EQ",t.NrSap);var r=new sap.ui.model.Filter("IvTipoBp","EQ",t.TipoBp);debugger;var n="/SociedadBPSet";o.read(m,n,{filters:[a,r]}).then(function(o){console.log(o);e.get(p).setProperty("/Combos/comboSociedad/rowTemplate",o.results);e.get(p).refresh()}).catch(function(e){console.log(e)})},onGetSchemas:function(){var e="/templates";var o=this;var t=v+e+"?clientId=simplotId";$.ajax({url:t,type:"GET",async:true,headers:{accept:"application/json",contentType:"application/json"},success:function(e){o.onGetObtenerBasico(e)},error:function(e){console.log(e)}})},onChangeTipoDoc:function(){var o=e.get(p).getProperty("/Combos/comboTipoFactura/selectKey");var t=e.get(p).getProperty("/Combos/comboSubtipoFactura/rowTemplateBack");var a=t.filter(e=>e.TipoDoc===o);e.get(p).setProperty("/Combos/comboSubtipoFactura/rowTemplate",a);e.get(p).refresh()},onSendFile:function(e){var o=this.getCommon();var t="/document/jobs";var a=this;var r={url:v+t,method:"POST",headers:{accept:"application/json",contentType:"application/json"},processData:false,mimeType:"application/json",contentType:false,data:e};$.ajax(r).done(function(e){a.onGetDataFileOCR(e.id);console.log(e)}).fail(function(e){console.log(e);o.onCloseBusy()})},onGetDataFileOCR:function(o){var t=this.getCommon();var a=this;var r="/document/jobs/"+o;$.ajax({url:v+r,type:"GET",async:true,headers:{accept:"application/json",contentType:"application/json"},success:function(o){if(o.status==="PENDING"){a.onGetDataFileOCR(o.id)}else{debugger;var r=e.get(p).getData().Combos.comboSubtipoFactura.selectKey;var n=e.get(p).getData().Combos.comboSubtipoFactura.rowTemplateBack;var s=n.filter(e=>e.SubtipoDoc===r)[0].LetraDoc;var i=e.get(p).getProperty("/headerFields");var l=e.get(p).getProperty("/Combos/iibbItemsFields");var c=e.get(p).getProperty("/Combos/ivaItemsFields");var m=e.get(p).getProperty("/Combos/ComboIIBB");var d=e.get(p).getProperty("/Combos/ComboIVA");var u=e.get(p).getProperty("/Combos/comboMoneda");var f=o.extraction.lineItems;var g=o.extraction.headerFields;for(var v in g){var b=g[v].name;i[b]=g[v].value}if(i.nroFactura.indexOf("-")>0){i.nroFactura=i.nroFactura.replace("-",s)}i.nroFactura=i.nroFactura.trim();i.nroFactura=i.nroFactura.replaceAll(" ","");debugger;var C=t.onCheckPointDecimal(i.total);i.total=t.onReturnNumberDecimal(i.total,C);i.total=t.onReturnFormatNumber(Number(i.total),2);i.subtotal=t.onReturnNumberDecimal(i.subtotal,C);i.subtotal=t.onReturnFormatNumber(Number(i.subtotal),2);if(isNaN(i.tipoCambio.substr(-1))){i.tipoCambio=i.tipoCambio.substring(0,i.tipoCambio.length-1)}i.tipoCambio=t.onReturnNumberDecimal(i.tipoCambio,C);if(i.tipoCambio===""||i.tipoCambio===undefined){i.tipoCambio=t.onReturnFormatNumber(Number("1"),5)}else{i.tipoCambio=t.onReturnFormatNumber(Number(i.tipoCambio),5)}i.fechaVto=i.fechaVto.replaceAll(".","/").replaceAll("-","/").replace(/[^0-9 /]/g,"");if(i.fechaVto.indexOf("/")<0){i.fechaVto=""}i.fecha=i.fecha.replaceAll(".","/").replaceAll("-","/").replace(/[^0-9 /]/g,"");if(i.fecha.indexOf("/")<0){i.fecha=""}i.cae=i.cae.replace(/[^0-9]/g,"");var y=u.rowTemplate.filter(e=>e.opciones.indexOf(i.moneda)>=0);if(y.length>0){e.get(p).setProperty("/Combos/comboMoneda/selectKey",y[0].key)}else{e.get(p).setProperty("/Combos/comboMoneda/selectKey",u[0].key)}var h=[];var P=[];var M=1;for(var v in c){var F=g.filter(e=>e.name===c[v].FieldClave);var I=g.filter(e=>e.name===c[v].FieldVal);if(F.length>0){var D;D=d.filter(e=>e.opciones.indexOf(F[0].value)>=0)[0];var S="";var x="";if(D!==undefined){if(D.key===undefined){}else{S=D.key;x=D.value}}if(I[0]===undefined){}else{var T=t.onReturnNumberDecimal(I[0].value,C);T=t.onReturnFormatNumber(Number(T),2);var B={ID:M,Item:x,Valor:T,key:S};M=M+1;P.push(B)}}}var O=[];var E=1;for(var v in f){var N={};for(var j in f[v]){var L=f[v][j].name;N[L]=f[v][j].rawValue}N.page=f[v][j].page;N.ID=E;O.push(N);E=E+1}e.get(p).setProperty("/headerFields",i);e.get(p).setProperty("/iibbItems",h);e.get(p).setProperty("/iibbItemsMax",h.length);e.get(p).setProperty("/ivaItems",P);e.get(p).setProperty("/ivaItemsMax",P.length);e.get(p).setProperty("/lineItems",O);e.get(p).setProperty("/lineItemsMax",O.length);e.get(p).refresh();t.onCloseBusy()}},error:function(e){t.onCloseBusy();console.log(e)}})},onDeleteItems:function(e,o,t,a){var r=e.getProperty(o);var n=e.getProperty(t);var s=n.findIndex(e=>e.ID===r.ID);n.splice(s,1);e.setProperty(t,n);e.setProperty(a,n.length);e.refresh()},onAddItems:function(e,o,t,a,r){o.push(t);e.setProperty(a,o);e.setProperty(r,o.length);e.refresh()},validTaxCharacter:function(e){var o={Key:"",Val:""};if(e.toString().length===1){o.Key="TaxKey0"+e;o.Val="TaxVal0"+e}else{o.Key="TaxKey"+e;o.Val="TaxVal"+e}return o},onCheckExencion:function(o,t,a,r,n){var s=e.get(p).getProperty("/ListaExenciones");var i=this.getCommon();if(s.length>0){var l=s.filter(e=>e.Sociedad===t&&e.TaxKey===a);if(l.length>0){for(var c in l){var m=new Date(i.formatDate(l[c].Desde,"FormatYYYY/MM/DD"));var d=new Date(i.formatDate(l[c].Hasta,"FormatYYYY/MM/DD"));if(r>m&&r<d){o.BoolContinue=false;if(o.Mensaje===""){o.Mensaje="Existe una exención para "+n.Item+"."}else{o.Mensaje=o.Mensaje+"\n Existe una exención para "+n.Item+"."}}}}}return o},onValueHelpOCs:function(){var o=this.getCommon();var t=e.get(u).getProperty("/ControllerMain");var a=this;var r,n=new jQuery.Deferred;if(!t._ControllerListOCs){t._ControllerListOCs={deferred:null,onPressCancel:function(e){r.close()},onSelectionChange:function(e){var o=e.getSource().getSelectedItem().getProperty("title");e.getSource().getModel().setProperty("/comboOrdenCompra/selectKey",o);e.getSource().getModel().refresh();r.close()}}}t._ControllerListOCs.deferred=n;if(!t._dialoListOCs){t._dialoListOCs=sap.ui.xmlfragment("simplot.portalsqas.view.fragment.ListsOCs",t._ControllerListOCs)}r=t._dialoListOCs;r.setModel(e.get(p));t.getView().addDependent(r);r.open()},onSendToSap:function(t,a,r){var n=this.getCommon();var s=this;n.onShowBusy();n.onChangeTextBusy(this.getI18nText("RecuperandoDatos"));var c={BoolContinue:true,Mensaje:""};var m=1;var d=e.get(p).getProperty("/File");var f=e.get("Model_User").getProperty("/DataUser");var g=e.get(p).getProperty("/headerFields");var v=e.get(p).getProperty("/Combos/comboTipoFactura/selectKey");var b=e.get(p).getProperty("/Combos/comboSubtipoFactura/selectKey");var C=e.get(p).getProperty("/Combos/comboCircuito/selectKey");var y=e.get(p).getProperty("/Combos/comboMoneda/selectKey");var h=e.get(p).getProperty("/Combos/comboModo/selectKey");var P=e.get(p).getProperty("/Combos/comboSociedad/selectKey");var M=e.get(p).getProperty("/comboOrdenCompra/selectKey");var F=e.get(p).getProperty("/ivaItems");var I=e.get(p).getProperty("/iibbItems");var D=e.get(p).getProperty("/Combos/ComboIVA");var S=e.get(p).getProperty("/Combos/ComboIIBB");var x=n.onCheckPointDecimal(g.total);var T=n.onReturnFormatToSend(g.total,x);var B=n.onReturnFormatToSend(g.subtotal,x);var O=n.onReturnFormatToSend(g.tipoCambio,x);if(Number(T)===0||Number(B)===0){c.BoolContinue=false;c.Mensaje="No puede enviar importes en 0."}if(y==="ARS"){O="1"}else{if(Number(O)===0){c.BoolContinue=false;c.Mensaje="No puede enviar importes en 0."}}var E=g.fecha;var N=g.fechaVto;if(E===""){}else{E=n.formatDate(a,"Update")}if(N===""){}else{N=n.formatDate(r,"Update")}var j=f.NrSap;var L={Lifnr:j,IdDoc:"",NumOc:M,Cae:g.cae,FechaDoc:E,CaeVenc:N,Moneda:y,TipoDoc:v,SubtipoDoc:b,ImpBruto:T,ImpNeto:B,Circuito:C,TipoCambio:O,NotaProveedor:g.NotaProveedor,Modo:h,Numero:g.nroFactura,Sociedad:P};for(var w in F){var K=n.validTaxCharacter(m);var R=n.onReturnFormatToSend(F[w].Valor,x);L[K.Key]=D.filter(e=>e.value===F[w].Item)[0].key;L[K.Val]=R;m=m+1;if(Number(R)===0){c.BoolContinue=false;c.Mensaje="No puede enviar importes en 0."}}debugger;var V=new Date(n.formatDate(E,"FormatYYYY/MM/DD"));var A=true;for(var w in I){var K=n.validTaxCharacter(m);var R=n.onReturnFormatToSend(I[w].Valor,x);L[K.Key]=S.filter(e=>e.value===I[w].Item)[0].key;L[K.Val]=R;if(Number(R)===0){c.BoolContinue=false;c.Mensaje="No puede enviar importes en 0."}c=this.onCheckExencion(c,P,L[K.Key],V,I[w]);m=m+1}debugger;if(M!==""){var _=e.get(p).getProperty("/comboOrdenCompra/rowTemplate").filter(e=>e.Ebeln===M)[0];if(_.Bukrs!==P){c.BoolContinue=false;if(c.Mensaje===""){c.Mensaje="La Sociedad cargada no coincide con la Orden de Compra elegida."}else{c.Mensaje=c.Mensaje+"\n La Sociedad cargada no coincide con la Orden de Compra elegida."}}if(_.Moneda!==y){c.BoolContinue=false;if(c.Mensaje===""){c.Mensaje="La Moneda cargada no coincide con la Orden de Compra elegida."}else{c.Mensaje=c.Mensaje+"\n La Moneda cargada no coincide con la Orden de Compra elegida."}}else{if(Number(T)>Number(_.TolFact)){c.BoolContinue=false;if(c.Mensaje===""){c.Mensaje="El importe total excede el total de la Orden de Compra elegida."}else{c.Mensaje=c.Mensaje+"\n El importe total excede el total de la Orden de Compra elegida.."}}}}var G={Lifnr:j,Sociedad:P,SubtipoDoc:b,Numero:g.nroFactura,FechaDoc:E,ImpTotal:T,Modo:h,Cae:g.cae};var k="/DocumentoSet";var U="/ConstataCompSet";if(c.BoolContinue){o.create(l,U,G).then(function(a){if(a.EvTipo==="E"){n.onCloseBusy();sap.m.MessageBox.error(a.EvMensaje)}else{o.create(i,k,L).then(function(a){console.log(a);if(a.EvTipo==="E"){n.onCloseBusy();sap.m.MessageBox.error(a.EvMensaje)}else{d=d;var r="/AdjuntoSet";var l={Archivo:d.name,Contenido:d.Contenido,IdDoc:a.IdDoc,Lifnr:j};o.create(i,r,l).then(function(o){console.log(o);n.onCloseBusy();sap.m.MessageBox.show("Se envio correctamente la factura.",{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Factura Enviada",actions:[sap.m.MessageBox.Action.OK],onClose:function(o){s.onCleanModelFacturas(t);e.get(u).getData().Targets.display("TargetMain")}});debugger}).catch(function(e){n.onCloseBusy();sap.m.MessageBox.error("Error al enviar la factura.");console.log(e)})}}).catch(function(e){n.onCloseBusy();sap.m.MessageBox.error("Error al enviar la factura.");console.log(e)})}}).catch(function(e){n.onCloseBusy();sap.m.MessageBox.error("Error al enviar la factura.");console.log(e)})}else{n.onCloseBusy();sap.m.MessageBox.error(c.Mensaje)}}}});