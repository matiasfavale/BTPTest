sap.ui.define(["simplot/portalsqas/utils/models","simplot/portalsqas/utils/gateway","simplot/portalsqas/utils/modelHelper","simplot/portalsqas/utils/FileDownHelp","simplot/portalsqas/utils/Common","sap/m/Button","sap/m/Dialog","sap/m/Text"],function(e,o,t,r,i,a,n,s){"use strict";var l="NOTICIAS";var c="AUTOGESTION";var p="Model_Pizarron";var g="Model_ControllerMain";return{getCommon:function(){var e=sap.ui.require("simplot/portalsqas/utils/Common");return e},getI18nText:function(o){return e.get("i18n").getProperty(o)},navToPizarron:function(e){this.onLoadModelPizarron();e.display("pizarron")},onLoadModelPizarron:function(){var o=[];if(e.exists(p)){}else{e.load(p,{rowsPizarron:[],rowsPizarronCount:0,rowsPizarronBack:[],MsgPopUpVisto:false})}e.get(p).refresh();this.onGetNoticias()},onViewCantidadNoticias:function(o){if(!e.exists(p)){this.onLoadModelPizarron()}if(e.get(p).getProperty("/MsgPopUpVisto")){}else{if(o.length>0){var t=this.getCommon();e.get(p).setProperty("/MsgPopUpVisto",true);e.get(p).refresh();var r=t.getI18nText("NewMsgsCount")+" "+o.length;var i=new n({title:t.getI18nText("Aviso"),type:"Message",state:"Warning",content:new s({text:r}),beginButton:new a({text:"OK",press:function(){var o=e.get(g).getProperty("/Targets");t.navToPizarron(o);i.close()}}),afterClose:function(){i.destroy()}});i.open()}}},onReadNoticia:function(t){var r=this;var i=e.get("Model_User").getProperty("/DataUser");var a="/MarcarVistoSet(IvBpSap='"+i.BpSap+"',IvCodnot='"+t+"')";o.read(l,a,{}).then(function(e){console.log(e);if(e.EvTipo==="E"){console.log(e.EvMensaje)}else{r.onGetNoticias();var o="Se marcó la noticia como leída.";console.log(o)}}).catch(function(e){console.log(e)})},onGetNoticias:function(t){var r=this;var i=this.getCommon();var a=e.get("Model_User").getProperty("/DataUser");var n=new sap.ui.model.Filter("IvTipoBp","EQ",a.TipoBp);var s=new sap.ui.model.Filter("IvBpSap","EQ",a.BpSap);var c="/ListaNoticiaBPSet";o.read(l,c,{filters:[s,n]}).then(function(o){var a=o.results;var n=a.filter(e=>e.Visto===false);e.get(g).setProperty("/Pizarron/CountNoticias",n.length);e.get(g).refresh();if(t==="Cantidad"){r.onViewCantidadNoticias(n)}else{for(var s in a){a[s].FechaHora=a[s].Fecha+""+a[s].Hora;a[s].Fecha=i.formatDate(a[s].Fecha,"Main");a[s].Hora=i.formatDate(a[s].Hora,"GetHour");a[s].isEnabledVisto=true;a[s].styleReadLabel="Bold";a[s].styleReadBtn="Emphasized";if(a[s].Visto){a[s].styleReadLabel="Standard";a[s].styleReadBtn="Default";a[s].isEnabledVisto=false}}a=a.sort(r.sortGlobal);e.get(p).setProperty("/rowsPizarron",a);e.get(p).setProperty("/rowsPizarronBack",a);e.get(p).setProperty("/rowsPizarronCount",a.length);e.get(p).refresh();console.log(o)}}).catch(function(e){console.log(e)})},sortGlobal:function(e,o){if(e["FechaHora"]>o["FechaHora"]){return-1}if(e["FechaHora"]<o["FechaHora"]){return 1}return 0},onGetCuerpoNoticia:function(t){var r=this.getCommon();var i="/ObtenerCuerpoSet('"+t+"')";o.read(l,i,{}).then(function(o){o.Titulo=e.get(p).getProperty("/ViewNoticia").Titulo;e.get(p).setProperty("/ViewNoticia",o);e.get(p).refresh();r.onCloseBusy();console.log(o)}).catch(function(e){console.log(e)})},onViewNoticia:function(o){var t=this.getCommon();var r=e.get(g).getProperty("/ControllerMain");var i=this;var a,n=new jQuery.Deferred;var s={EvCuerpo:"",Titulo:o.Titulo};e.get(p).setProperty("/ViewNoticia",s);e.get(p).refresh();if(!r._ControllerViewNoticia){r._ControllerViewNoticia={deferred:null,onPressCancelNoticia:function(e){a.close()},onPressConfirmNoticia:function(e){a.close()}}}r._ControllerViewNoticia.deferred=n;if(!r._dialogViewNoticia){r._dialogViewNoticia=sap.ui.xmlfragment("simplot.portalsqas.view.fragment.ViewNoticia",r._ControllerViewNoticia)}a=r._dialogViewNoticia;a.setModel(e.get(p));r.getView().addDependent(a);a.open();t.onShowBusy();t.onChangeTextBusy(t.getI18nText("NewMsgsCount"));setTimeout(function(){i.onGetCuerpoNoticia(o.Codnot);if(o.Visto){}else{i.onReadNoticia(o.Codnot)}},2e3)}}});