sap.ui.define(["sap/ui/model/json/JSONModel","simplot/portalsprd/controller/BaseController","simplot/portalsprd/utils/controller/CommonClaims","simplot/portalsprd/utils/FileReaderHelp"],function(e,t,i,s){"use strict";return t.extend("simplot.portalsprd.controller.Claim.Claim",{onInit:function(){this._oTable=this.getView().byId("claims-table");i.getReasons().then(t=>{this.setModel(new e({Reasons:t}),"matchcodes")});this.getView().setModel(this.getOwnerComponent().getModel(i.getServiceName()));this.getRouter().getTarget("claim").attachDisplay(this._onObjectMatched,this)},onClaimSavePress:function(){this.getView().setBusy(true);if(this.getModel().hasPendingChanges()&&(this.getView().getBindingContext().bCreated===undefined||!this.getView().getBindingContext().bCreated)){this.getModel().setProperty(this.getView().getBindingContext().getPath()+"/AutorMod","1");this.getModel().setProperty(this.getView().getBindingContext().getPath()+"/UsuarioMod",i.getBpSap());this._saveClaim()}else{this._saveClaim().then(()=>{const e=this.getView().getElementBinding().getBoundContext().getObject();i.navToClaim(this.getOwnerComponent().getTargets(),e.Nrorec)})}},onClaimBackPress:function(){debugger;var e=this.byId("attachmentBlock").getId()+"-Collapsed";var t=sap.ui.getCore().byId(e+"--UploadSet").getItems();for(var i in t){if(t[i].getProperty("visibleEdit")){sap.ui.getCore().byId(e+"--UploadSet").removeItem(t[i])}}this.getModel().resetChanges(null,true);this.onNavBack()},onClaimClosePress:function(){const e=this.getView().getBindingContext().getObject();sap.m.MessageBox.confirm(this.getResourceBundle().getText("claim.closeConfirm.message",[e.Nrorec]),{onClose:this._onClaimCloseConfirmed.bind(this)})},onNavBack:function(){this.getOwnerComponent().getTargets().display("claims")},_onObjectMatched:function(e){this.getModel().resetChanges(null,true);const t=e.getParameter("data"),i=this._getEntryKey(t);this._initModels();this._bindView(i)},_initModels:function(){this.setModel(new e({Prioridades:i.getPriorities()}),"matchcode");this.setModel(new e({isEditable:true,busy:false}),"viewModel")},_getEntryKey:function(e){let t=null;if(e.nrorec){t="/"+this.getModel().createKey("ReclamoSet",{Nrorec:e.nrorec})}else{const e=this.getModel().createEntry("/ReclamoSet",{properties:{Nrorec:"0000000000",BpSap:i.getBpSap(),Prioridad:"2"}});t=e.getPath()}return t},_onClaimCloseConfirmed:function(e){if(e===sap.m.MessageBox.Action.OK){this.getView().setBusy(true);const e=this.getView().getBindingContext().getPath();this.getModel().setProperty(e+"/Estado","3");this.getModel().setProperty(e+"/AutorMod","2");this.getModel().setProperty(e+"/UsuarioMod",i.getBpSap());this._saveClaim()}},_uploadFiles:function(e){const t=this.getView().getBindingContext().getObject();return Promise.all(e.map((e,i)=>s.readBinaryStringPromise(e).then(s=>{const o=this.getModel().createEntry("/AdjuntoSet",{changeSetId:`changeSet-${i}`,properties:{Nrorec:t.Nrorec,Contenido:s,Archivo:e.name,Autor:"1"}});return o}))).then(e=>{debugger;return this._submitChanges()}).catch(e=>{debugger;this.getMessageDialog().addResponse(e)}).finally(()=>{this.getView().setBusy(false)})},_saveClaim:function(){debugger;var e=this.byId("attachmentBlock").getId()+"-Collapsed";var t=sap.ui.getCore().byId(e+"--UploadSet");var i=t.getItems();var s=i.filter(e=>e.getProperty("visibleEdit")===true);return this._submitChanges().then(t=>{this.getMessageDialog().addResponse(t);debugger;return this._uploadFiles(s.map(e=>e.getFileObject())).then(()=>{for(var t in s){sap.ui.getCore().byId(e+"--UploadSet").removeItem(s[t])}}).then(()=>{sap.m.MessageToast.show(this.getResourceBundle().getText("claim.message.crudSuccefully"))})}).catch(e=>{this.getMessageDialog().addResponse(e)}).finally(()=>{this.getView().setBusy(false)})},_submitChanges:function(){return new Promise(function(e,t){this.getModel().submitChanges({success:function(t,i){e(i)},error:t})}.bind(this))},_bindView:function(e){var t=this.getModel("viewModel"),i=this.getModel();this.getView().bindElement({path:e,parameters:{expand:"Posiciones,Adjuntos"},events:{change:this._onBindingChange.bind(this),dataRequested:function(){i.metadataLoaded().then(function(){t.setProperty("/busy",true)})},dataReceived:function(){t.setProperty("/busy",false)}.bind(this)}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("viewModel"),i=e.getElementBinding();if(!i.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}t.setProperty("/busy",false)}})});